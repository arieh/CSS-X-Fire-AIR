<html>
    <head>
        <title>New Adobe AIR Project</title>
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/air/AIRMenuBuilder.js"></script>
        <script type="text/javascript" src="lib/air/AIRSourceViewer.js"></script>
		<script type="text/javascript" src="lib/mootools-core-1.3.js"></script>
		<script type="text/javascript" src="lib/mootools-more.js"></script>
        <script src="lib/db-setup.js"></script>
		<script src='lib/db-ver-0.4.js'></script>
        <script src='lib/Settings.js'></script>
		<script src="lib/FolderTable.js"></script>
		<script src='lib/SocketHandler.js'></script>
        <script src='lib/CSSHandler.js'></script>
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/main.css">
    </head>
    <body>
    	<div id='wrapper'>
    	<nav>
	    	<button id='start'>On</button> 
			<button id='end' class='active'>Off</button>
			<button id='manage_sites'>Manage Sites</button>
			<button id="change_settings">Settings</button>
		</nav>
		<div id='settings'></div>
		<div id='sites_cont'>
		<table id='sites'>
    		<thead>
    			<tr>
    				<th>Site Address</th>
					<th>Folder</th>
				    <th>State</th>
					<th></th>
    			</tr>
    		</thead>
			<tbody>
				
			</tbody>
			<tfoot>
				<tr>					<td colspan="4">
				        <form id='add_folder' action="#">
				            <label for='address'>Address</label>
				            <input type='url' id='address' name='address' placeholder="Your site's address" />
				            <label for='folder'>Folder</label>
				            <input type='text' id='folder' name='folder' placeholder="You site's folder on the server" />
				            <input type='submit' value='add folder' />
				        </form>		
					</td>				</tr>
			</tfoot>
    	</table>
		</div>
		<h1>Changes</h1>
		<table id='changes'>			<thead>
				<tr>					<th>File</th>					<th>Prop</th>					<th>Value</th>					<th>Action</th>				</tr>
			</thead>			<tbody>
				
			</tbody>		</table>
		</div>
    	<script type="text/javascript">
			var sites_open = false
			  , settings = new Settings(__db__)
              , sites_fx = new Fx.Tween('sites_cont')
			  , changes = $$('#changes tbody')[0]
			  , on = false
	          , table = new FolderTable('sites',__db__)
	          , socket = new SocketHandler()
	          , css = new CSSHandler(table,__db__);
			  
            socket.addEvent('response',css.handleResponse);
			settings.get(['host','port'],function(data){
				socket.options = data;
			});
			
			function start(){
				socket.listen();
				on=true;
				$('start').addClass('active');
				$('end').removeClass('active');
			}
			
			function end(){
				socket.close();
				on = false;
                $('end').addClass('active');
                $('start').removeClass('active');
		    }
			
			$('start').addEvent('click',start);
			$('end').addEvent('click',end);		
			 
			$('sites_cont').addEvent('click',function(e){
			     var url, state;
				 if (e.target.get('tag')=='a'){
				 	url = $(e.target).getParent('tr').getElement('.url').get('text').trim();
					if (e.target.hasClass('remove')) {
						table.removeSite(url);
					}else if (e.target.hasClass('toggle-on')){
						state = +(e.target.get('data-state'))*-1+1;
						table.toggle(url,state);
						e.target.set('text',(state ? 'turn off' : 'turn on'));
						e.target.set('data-state',state);  
					}
					
				 }
			});
			
			$('manage_sites').addEvent('click',function(){
				sites_fx.start('height',sites_open ? 0 : '150px');
				sites_open = sites_open ? false : true;
			});
			
			$('add_folder').addEvent('submit',function(){
				table.addSite($('address').value,$('folder').value);
			});
			
			$('change_settings').addEvent('click',function(){
				settings.populateSettings('settings');
			});
			
			css.addEvent('write',function(data){
				changes.adopt(
				    new Element('tr').adopt(
					    new Element('td',{html:data.src})
						, new Element('td',{html:data.property})
						, new Element('td',{html:data.value})
						, new Element('td',{html:data.action})
				    )
				);				
			});
			
			settings.addEvent('update',function(prop,value){
				if (prop == 'host' || prop == 'port'){
					socket.options[prop] = value;
					socket.close();
					socket.listen();
				}
			});
			
			settings.get('start',function(data){
				if (data.start==1) start();
				
			})
        </script>
    </body>
</html>
